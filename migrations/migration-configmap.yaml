# SQL Migration Files ConfigMap
# Mounted into Flyway container at /flyway/sql
apiVersion: v1
kind: ConfigMap
metadata:
  name: migration-sql
  annotations:
    argocd.argoproj.io/sync-wave: "0"
  labels:
    app: migrations-demo
data:
  V001__create_users_table.sql: |
    -- Create users table
    CREATE TABLE IF NOT EXISTS users (
        id SERIAL PRIMARY KEY,
        username VARCHAR(255) NOT NULL UNIQUE,
        email VARCHAR(255) NOT NULL UNIQUE,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );

    -- Insert sample data
    INSERT INTO users (username, email) VALUES
        ('alice', 'alice@globomantics.com'),
        ('bob', 'bob@globomantics.com'),
        ('charlie', 'charlie@globomantics.com')
    ON CONFLICT (username) DO NOTHING;

  V002__add_email_index.sql: |
    -- Add index on email column for faster lookups
    CREATE INDEX IF NOT EXISTS idx_users_email ON users(email);

  V003__create_orders_table.sql: |
    -- Create orders table with foreign key to users
    CREATE TABLE IF NOT EXISTS orders (
        id SERIAL PRIMARY KEY,
        user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
        order_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        total_amount DECIMAL(10, 2) NOT NULL,
        status VARCHAR(50) DEFAULT 'pending',
        CONSTRAINT valid_amount CHECK (total_amount >= 0)
    );

    -- Insert sample orders
    INSERT INTO orders (user_id, total_amount, status) VALUES
        (1, 99.99, 'completed'),
        (2, 149.50, 'pending'),
        (1, 249.99, 'shipped')
    ON CONFLICT DO NOTHING;

  V004__add_indexes.sql: |
    -- Add performance indexes for common queries
    CREATE INDEX IF NOT EXISTS idx_orders_user_id ON orders(user_id);
    CREATE INDEX IF NOT EXISTS idx_orders_status ON orders(status);
    CREATE INDEX IF NOT EXISTS idx_orders_order_date ON orders(order_date);

    -- Add composite index for filtering by user and status
    CREATE INDEX IF NOT EXISTS idx_orders_user_status ON orders(user_id, status);
